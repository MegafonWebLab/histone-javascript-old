<!DOCTYPE HTML>
<html>
	<head>
		<title>tests</title>
		<link rel="shortcut icon" href="favicon.ico" />
		<style type="text/css">html { font-family: monospace; }</style>
		<script type="text/javascript" src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
		<script type="text/javascript" src="http://requirejs.org/docs/release/2.1.0/minified/require.js"></script>
		<script type="text/javascript">

			var requestURL = 'https://api.github.com/repos';
			var ownerID = 'megafonweblab';
			var repoID = 'histone-acceptance-tests';

			function isString(value) {
				return (typeof(value) === 'string');
			}

			function isArray(value) {
				return (value instanceof Array);
			}

			function isObject(value) {
				return (value instanceof Object && !isArray(value));
			}

			function getContents(path, callback) {
				$.ajax({url: [
					requestURL, ownerID, repoID, 'contents', path
				].join('/'), dataType: 'jsonp', success: callback});
			}

			function getBlob(sha, callback) {
				$.ajax({url: [
					requestURL, ownerID, repoID, 'git/blobs', sha
				].join('/'), dataType: 'jsonp', success: function(result) {
					var result = result.data.content;
					result = result.replace(/\n/g, '');
					callback(atob(result));
				}});
			}

			function log(group, input, expected, result, type) {
				var div = document.createElement('div');
				div.style.color = (type ? 'green' : 'red');
				div.innerHTML = '[ ' + group + ' ] ' + input;
				document.body.appendChild(div);
				if (!type) {
					var div = document.createElement('div');
					div.style.color = 'red';
					div.innerHTML = ('[ ' + group + ' ] ').replace(/./g, '&nbsp;');
					div.innerHTML += ('result is: ' + JSON.stringify(expected));
					document.body.appendChild(div);

					var div = document.createElement('div');
					div.style.color = 'red';
					div.innerHTML = ('[ ' + group + ' ] ').replace(/./g, '&nbsp;');
					div.innerHTML += ('expected is: ' + JSON.stringify(expected));
					document.body.appendChild(div);
				}
			}

			requirejs.config({
				urlArgs: Math.random()
			})(['../src/Histone'], function(Histone) {

				Histone.setURIResolver(function(requestURI, baseURI, ret) {
					Histone.Global.resolveURI(
						Histone.Global,
						[requestURI, baseURI],
						function(resolvedURI) {
							getContents(resolvedURI, function(resource) {
								var sha = resource.data.sha;
								if (sha) {
									getBlob(sha, function(f) {
										ret(f, resolvedURI);
									});
								} else ret(undefined, resolvedURI);
							});
						}
					);
					return true;
				});

				function runTestCase(testCase, groupName, baseURI) {
					var templateStr = testCase.input;
					var expectedAST = testCase.expectedAST;
					var expectedResult = testCase.expectedResult;
					var expectedException = testCase.expectedException;
					try {
						var template = Histone(templateStr, baseURI);
						if (isArray(expectedAST)) {
							expectedAST = JSON.stringify(expectedAST);
							var actualAST = JSON.stringify(template.getAST());
							if (expectedAST !== actualAST) {
								return log(
									groupName, templateStr,
									expectedAST, actualAST,
									false
								);
							}
						}
						if (isString(expectedResult)) {
							template.render(function(actualResult) {
								if (isObject(expectedException)) {
									log(
										groupName, templateStr,
										expectedException, null,
										false
									);
								}
								else if (expectedResult !== actualResult) {
									log(
										groupName, templateStr,
										expectedResult, actualResult,
										false
									);
								}
								else {
									log(
										groupName, templateStr,
										null, null,
										true
									);
								}
							}, testCase.context);
						}
						else if (isObject(expectedException)) {
							log(
								groupName, templateStr,
								expectedException, null,
								false
							);
						} else {
							log(
								groupName, templateStr,
								null, null,
								true
							);
						}
					} catch (actualException) {
						for (var expectedKey in expectedException) {
							if (!actualException.hasOwnProperty(expectedKey) ||
								String(actualException[expectedKey]) !==
								String(expectedException[expectedKey])) {
								return log(
									groupName,
									templateStr,
									expectedException,
									actualException,
									false
								);
							}
						}
					}
				}

				getContents('src/main/acceptance', function(testFiles) {
					var testFiles = testFiles.data;
					while (testFiles.length) {
						var testFile = testFiles.shift();
						var testFileName = testFile.name;
						var testFileExt = testFileName.split('.').pop();
						if (testFileExt !== 'json') continue;

						(function(testFile) {
							getBlob(testFile.sha, function(testSuites) {
								testSuites = JSON.parse(testSuites);
								while (testSuites.length) {
									var testSuite = testSuites.shift();
									while (testSuite.cases.length) {
										runTestCase(
											testSuite.cases.shift(), (
												'"' +
												testFile.name +
												'" -> "' +
												testSuite.name +
												'"'
											),
											testFile.path
										);
									}
								}
							});
						})(testFile);
					}
				});

			});

		</script>
	</head>
	<body>

		<!--script type="text/javascript" src="https://api.github.com/repos/megafonweblab/histone-acceptance-tests/contents/src/main/acceptance/parser?callback=start"></script-->
	</body>
</html>