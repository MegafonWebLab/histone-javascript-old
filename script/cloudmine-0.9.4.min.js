(function(){function e(e){this.options=E(this,e),V(this)}function n(e){this.config=U({},o,e),this._events={};var i="JS/"+t,s=this.config.options;s.appname&&(i+=" "+s.appname.replace(y,"_"),s.appversion&&(i+="/"+s.appversion.replace(y,"_"))),this.additionalData=this.config.callbackData,this.data=null,this.hasErrors=!1,this.requestData=this.config.data,this.requestHeaders={"X-CloudMine-ApiKey":s.apikey,"X-CloudMine-Agent":i,"X-CloudMine-UT":s.user_token},this.responseHeaders={},this.responseText=null,this.status=null,this.type=this.config.type||"GET";var u=q(S(s,this.config.query)),a="/",f=s.session_token,l=s.applevel;if(l===!1||l!==!0&&f!=null)e.action.split("/")[0]!=="account"&&(a="/user/"),f!=null&&(this.requestHeaders["X-CloudMine-SessionToken"]=f);for(var c in this.config.headers)k(this.requestHeaders,c,this.config.headers[c]);this.config.headers=this.requestHeaders,F(r)||(this.config.headers["X-CloudMine-UT"]+=";"+q(r,":",","),r={});if(e.username||e.password)this.config.headers.Authorization="Basic "+K(e.username+":"+e.password),this.config.username=null,this.config.password=null;this.setContentType(e.contentType||"application/json"),this.url=[et,"/v1/app/",this.config.options.appid,a,this.config.action,u?"?"+u:""].join("");var h=this,p=this.config,d=Date.now();this.config.complete=function(e,t){var i;if(e){i=e.responseText,h.status=e.status,h.responseText=i,h.responseHeaders=R(e.getAllResponseHeaders(),/:\s*/,/(?:\r|\n)?\n/);var s=h.responseHeaders["X-Request-Id"];s&&(r[s]=Date.now()-d);try{h.data=JSON.parse(i||"{}")}catch(o){h.data=i}}else h.status="abort",h.data=[p.data];t=="success"&&h.status>=200&&h.status<300?i=p.processResponse.call(h,h.data,e,h):(i={errors:{}},A(h.data)&&(h.data={errors:[h.data]}),i.errors[h.status]=h.data),setTimeout(function(){n.complete(h,i)},1)},!this.config.later&&this.config.async&&setTimeout(function(){h.xhr=G(h.url,p)},1)}function i(e,t){t=t||{},this.status=400,this.responseText=[],this._headers={};var n=Z.parse(e);n.agent=!1,n.method=t.type,n.headers=t.headers||{},L(t.data)&&t.processData&&(t.data=JSON.stringify(t.data));if(t.username||t.password)n.headers.Authorization="Basic "+K(t.username+":"+t.password);_(t.data)?n.headers["content-length"]=v.byteLength(t.data):A(t.data)&&(n.headers["content-length"]=t.data.length);var r=this,i=t.context||this;this._textStatus="success",this._request=(n.protocol==="http:"?J:Q).request(n,function(e){e.setEncoding(t.encoding||"utf8"),e.on("data",function(e){r.responseText.push(e)}),e.on("close",function(){e.emit("end")}),e.on("end",function(){r._headers=q(e.headers,": ","\n",!0)||"",r.status=e.statusCode;var n=r.responseText=r.responseText.join("");if(t.dataType=="json"||t.dataType!="text"&&e.headers["content-type"].match(/\bapplication\/json\b/i))try{n=JSON.parse(n)}catch(s){r._textStatus="parsererror"}r._textStatus=="success"&&r.status>=200&&r.status<300?t.success&&t.success.call(i,n,"success",r):t.error&&t.error.call(i,r,"error",r.responseText),t.complete&&t.complete.call(i,r,r._textStatus)})}),this._request.on("error",function(e){r.status=e.status,r.responseText=e.message,r._textStatus="error",t.error&&t.error.call(i,r,"error",e.message),t.complete&&t.complete.call(i,r,"error")}),this._request.end(t.data)}function b(){return Math.round(Math.random()*15).toString(16)}function w(){var e=Array(32),t;e[14]=4,e[19]=(Math.round(Math.random()*16)&3|8).toString(16);for(t=0;t<14;++t)e[t]=b();for(t=15;t<19;++t)e[t]=b();for(t=20;t<32;++t)e[t]=b();return e.join("")}function E(e,t){return U({},e.options,t)}function S(e,t){var n,r;t==null&&(t={});for(n in s)r=s[n],e[n]!=null&&(t[r]=e[n]);return t}function x(e,t,n){return C(e,function(e){return(!t||e[0]==t)&&(!n||n==e[1])})}function T(e,t,n){return Array.prototype.slice.call(e,t||0,n||e.length)}function N(e,t,n){n=n||this;if(_(e))if(e.forEach)e.forEach(t,n);else for(var r=0;r<e.length;++r){var i=e[r];i!=null&&t.call(n,i,s,n)}else if(L(e))for(var s in e){var i=e[s];i!=null&&t.call(n,i,s,n)}}function C(e,t,n){var r=null;return n=n||this,_(e)?e.filter?r=e.filter(t,n):(r=[],N(e,function(e,n,i){t.apply(this,arguments)&&r.push(e)})):(r={},N(e,function(e,n,i){t.apply(this,arguments)&&(r[n]=e)})),r}function k(e,t,n){if(e[t]==null){var r=t.toLowerCase();for(var i in e)if(i.toLowerCase()===r){t=i;break}}return n!==undefined&&(e[t]=n),e[t]}function L(e){return e&&typeof e=="object"}function A(e){return typeof e=="string"}function O(e){return typeof e=="number"&&!isNaN(e)}function M(e){return L(e)&&g.indexOf(e.constructor)>-1}function _(e){return e===null?!1:L(e)&&e.length!=null}function D(e){return typeof e=="function"}function P(e){return L(e)&&e.__type__==="geopoint"}function H(e,t){if(O(e)&&O(t))return{latitude:t,longitude:e};if(L(e)){if(t&&P(e[t]))return H(e[t]);var n={latitude:e.latitude||e.lat||e.y,longitude:e.longitude||e.lng||e.x};if(O(n.latitude)&&O(n.longitude))return n;for(var r in e)if(P(e[r]))return{latitude:e.latitude||e.lat||e.y,longitude:e.longitude||e.lng||e.x}}return null}function B(e){if(typeof Object.keys=="function")return Object.keys(e);if(typeof e=="object"){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push(n);return t}throw new TypeError("Object.keys used on non-object")}function j(e,t){if(_(e)&&_(t)){if(e.length==t.length){for(var n=0;n<e.length;++n)if(L(e[n])||_(e[n])){if(!j(e[n],t[n]))return!1}else if(e[n]!==t[n])return!1;return!0}return!1}if(L(e)&&L(t)){if(j(B(e),B(t))){var r=B(e);for(var n=0;n<r.length;++n){var i=r[n];if(L(e[i])||_(e[i])){if(!j(e[i],t[i]))return!1}else if(e[i]!==t[i])return!1}return!0}return!1}return!1}function F(e){if(e)for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}function I(e,t){var n;t||(t=l),e=new Uint8Array(e);try{n=new Blob(e,{type:t})}catch(r){var i=new p;i.append(e),n=i.getBlob(t)}return n}function q(e,t,n,r){t=t||"=";var i=[],s,o=r?X:encodeURIComponent;for(var u in e)e[u]!=null&&!D(e[u])&&(s=L(e[u])?JSON.stringify(e[u]):e[u],i.push(o(u)+t+o(s)));return i.join(n||"&")}function R(e,t,n,r){e=e.split(n||"&");var i={},s=r?X:decodeURIComponent;for(var o=0;o<e.length;++o){var u=e[o].split(t);i[s(u.shift())]=s(u.join(t))}return i}function U(e){for(var t=1;t<arguments.length;++t)N(arguments[t],function(t,n,r){t!=null&&(e[n]=t)});return e}function z(e){if(L(e)){var t=[];for(var n in e)t.push(n+" = "+JSON.stringify(e[n]));return"["+t.join(", ")+"]"}return e}function W(){throw new Error("Unsupported operation")}function X(e){return e}function V(e){var t,n="cmut_"+e.options.appid;if(Y){var r="/tmp/."+n;try{t=fs.readFileSync(r,"utf8")}catch(i){t=w();try{fs.writeFileSync(r,t)}catch(i){}}}else if(window.localStorage)t=localStorage.getItem(n),t||(t=w(),localStorage.setItem(n,t));else{var s=R(document.cookie,"=",";");s[n]?t=s[n]:(t=w(),document.cookie=n+"="+t+"; expires="+(new Date(33333333333333)).toUTCString()+"; path=/")}e.options.user_token=t}e.prototype={get:function(e,t){_(e)?e=e.join(","):L(e)&&(t=e,e=null),t=E(this,t);var r=e?S(t,{keys:e}):null;return new n({action:"text",type:"GET",options:t,query:r})},update:function(e,t,r){if(L(e))r=t;else{e||(e=w());var i={};i[e]=t,e=i}return r=E(this,r),new n({action:"text",type:"POST",options:r,query:S(r),data:JSON.stringify(e)})},set:function(e,t,r){if(L(e))r=t;else{e||(e=w());var i={};i[e]=t,e=i}return r=E(this,r),new n({action:"text",type:"PUT",options:r,query:S(r),data:JSON.stringify(e)})},destroy:function(e,t){return t=E(this,t),e==null&&t.all===!0?e={all:!0}:e={keys:_(e)?e.join(","):e},new n({action:"data",type:"DELETE",options:t,query:S(t,e)})},run:function(e,t,r){return r=E(this,r),t=U({},r.params,t),r.params=null,r.snippet=null,new n({action:"run/"+e,type:r.method||"GET",query:t,options:r})},search:function(e,t){return t=E(this,t),e={q:e!=null?z(e):""},new n({action:"search",type:"GET",query:S(t,e),options:t})},searchFiles:function(e,t){e=z(e);var n='[__type__ = "file"';return!e||e.replace(/\s+/,"").length==0?n+="]":e[0]!="["?n+="]."+e:n+=(e[1]=="]"?"":", ")+e.substring(1),this.search(n,t)},searchUsers:function(e,t){return e={p:e!=null?z(e):""},t=E(this,t),new n({action:"account/search",type:"GET",query:S(t,e),options:t})},allUsers:function(e){return e=E(this,e),new n({action:"account",type:"GET",query:S(e,""),options:e})},getUser:function(e,t){return t=E(this,t),new n({action:"account/"+e,type:"GET",query:S(t,""),options:t})},searchGeo:function(e,t,n,r){var i,r;L(t)?(r=n||{},i=H(t,e)):(r||(r={}),i=H(t,n));if(!i)throw new TypeError("Parameters given do not provide geolocation data");var s=r.radius;O(s)?s=", "+s+(r&&r.units?r.units:"km"):A(s)&&s.length?(s=", "+s,r.units||(r.units=s.match(/mi?|km|ft/)[0])):s="";var o=(e||"location")+" near ("+i.longitude+", "+i.latitude+")"+s;return this.search("["+o+"]",r)},upload:function(e,t,r){function s(e,t){r.contentType||(r.contentType=t||l),n.binaryUpload(i,e,r.filename,r.contentType).done()}r=E(this,r),e||(e=w()),r.filename||(r.filename=e);var i=new n({action:"binary/"+e,type:"post",later:!0,encoding:"binary",options:r,processResponse:n.basicResponse});if(A(t)||v&&t instanceof v)Y?(A(t)&&(t=require("fs").readFileSync(t)),s(t)):W();else if(t.toDataURL)s(t,"image/png");else if(m&&t instanceof m)s(t.canvas,"image/png");else if(M(t)){var o=new h;o.onabort=function(){i.setData("FileReader aborted").abort()},o.onerror=function(e){i.setData(e.target.error).abort()},o.onload=function(e){s(e.target.result)},c&&t instanceof c?!r.contentType&&t.type!=""&&(r.contentType=t.type):t=I(t,r.contentType||l),o.readAsDataURL(t)}else W();return i},download:function(e,t){t=E(this,t);var r={success:{}},i;t.filename&&(i={force_download:!0,apikey:t.apikey,session_token:t.session_token,filename:t.filename});var s=new n({action:"binary/"+e,type:"GET",later:!0,encoding:"binary",options:t,query:i});if(t.filename){if(Y)s.setProcessor(function(n){return r.success[e]=require("fs").writeFileSync(t.filename,n,"binary"),r}).done();else{function o(){u.parentNode&&document.body.removeChild(u)}var u=document.createElement("iframe");u.style.display="none",document.body.appendChild(u),setTimeout(function(){u.src=s.url},25),u.onload=function(){clearTimeout(o.timer),o.timer=setTimeout(o,5e3)},o.timer=setTimeout(o,6e4),r.success[e]=u}s.done(r)}else t.mode==="buffer"&&(d||v)?s.setProcessor(function(t){var n;if(v)n=new v(t,"binary");else{n=new d(t.length);var i=new Uint8Array(n);for(var s=0;s<t.length;++s)i[s]=t[s]&255}return r.success[e]=n,r}).done():s.setProcessor(function(t){return r.success[e]=t,r}).done();return s},createUser:function(e,t,r){L(e)?r=t:e={userid:e,password:t},r=E(this,r),r.applevel=!0;var i=JSON.stringify({email:e.userid,password:e.password});return new n({action:"account/create",type:"POST",options:r,processResponse:n.basicResponse,data:i})},updateUser:function(e,t,r){if(L(e))r=t;else{var i={};i[e]=t,e=i}return r=E(this,r),new n({action:"account",type:"POST",options:r,query:S(r),data:JSON.stringify(e)})},changePassword:function(e,t,r,i){L(e)?i=t:e={userid:e,oldpassword:t,password:r},i=E(this,i),i.applevel=!0;var s=JSON.stringify({password:e.password});return new n({action:"account/password/change",type:"POST",data:s,options:i,processResponse:n.basicResponse,username:e.userid,password:e.oldpassword})},resetPassword:function(e,t){t=E(this,t),t.applevel=!0;var r=JSON.stringify({email:e});return new n({action:"account/password/reset",type:"POST",options:t,processResponse:n.basicResponse,data:r})},confirmReset:function(e,t,r){r=E(this,r),r.applevel=!0;var i=JSON.stringify({password:t});return new n({action:"account/password/reset/"+e,type:"POST",data:i,processResponse:n.basicResponse,options:r})},login:function(e,t,r){L(e)?r=t:e={userid:e,password:t},this.options.userid=null,this.options.session_token=null,r=E(this,r),r.applevel=!0;var i=this;return(new n({action:"account/login",type:"POST",options:r,username:e.userid,password:e.password,processResponse:n.basicResponse})).on("success",function(e){i.options.userid=e.userid,i.options.session_token=e.session_token})},logout:function(e){e=E(this,e),e.applevel=!0;var t=this.options.session_token;return this.options.userid=null,this.options.session_token=null,new n({action:"account/logout",type:"POST",processResponse:n.basicResponse,headers:{"X-CloudMine-SessionToken":t},options:e})},verify:function(e,t,r){return L(e)?E=t:e={userid:e,password:t},r=E(this,r),r.applevel=!0,new n({action:"account/login",type:"POST",processResponse:n.basicResponse,username:e.userid,password:e.password,options:r})},deleteUser:function(e,t,r){L(e)?r=t:e={userid:e,password:t},r=E(this,r),r.applevel=!0;var i={action:"account",type:"DELETE",options:r,processResponse:n.basicResponse};return e.password?(this.options.session_token=null,this.options.username=null,i.username=e.userid,i.password=e.password):i.action+="/"+e.userid,new n(i)},isLoggedIn:function(){return!!this.options.session_token},getUserID:function(){return this.options.userid},getSessionToken:function(){return this.options.session_token},getOption:function(e){return s[e]?this.options[e]:null},setOption:function(e,t){return s[e]?(this.options[e]=t,!0):!1},useApplicationData:function(e){this.options.applevel=e===!0||e===!1?e:undefined},isApplicationData:function(){return this.options.applevel===!0||this.options.applevel===!1?this.options.applevel:this.options.session_token==null}};var t="0.9.4";e.VERSION=t,n.prototype={on:function(e,t,n){if(D(t)){n=n||this,this._events[e]||(this._events[e]=[]);var r=this;this._events[e].push([t,n,function(){r.off(e,t,n),t.apply(this,arguments)}])}return this},trigger:function(e){var t=this._events[e];if(t!=null){var n=T(arguments,1);N(t,function(e){e[2].apply(e[1],n)})}return this},off:function(e,t,n){return e==null&&t==null&&n==null?this._events={}:e==null?N(this._events,function(e,r,i){i._events[r]=x(e,t,n)}):this._events[e]=x(this._events[e],t,n),this},setContentType:function(e){return e=e||l,this.config&&(this.config.contentType=e,k(this.requestHeaders,"content-type",e),k(this.config.headers,"content-type",e)),this},abort:function(){return this.xhr?this.xhr.abort():this.config&&this.config.complete.call(this,this.xhr,"abort"),this.xhr&&(this.xhr=undefined,delete this.xhr),this.config&&(this.config=undefined,delete this.config),this},setData:function(e){return!this.xhr&&this.config&&(this.config.data=e),this},setProcessor:function(e){return!this.xhr&&this.config&&(this.config.processResponse=e),this},done:function(e){if(!this.xhr&&this.config)if(e){this.xhr=!0;var t=this;setTimeout(function(){n.complete(t,e)},1)}else this.xhr=G(this.url,this.config);return this},getHeader:function(e){return k(this.responseHeaders,e)}},n.complete=function(e,t){t.errors&&(e.hasErrors=!0),e.config&&(e.config=undefined,delete e.config),e.xhr&&(e.xhr=undefined,delete e.xhr),t.success&&(u[e.status]&&e.trigger(u[e.status],t.success,e,e.status),e.trigger(e.status,t.success,e,e.status),e.trigger("success",t.success,e)),t.meta&&e.trigger("meta",t.meta,e),t.result&&e.trigger("result",t.result,e);if(t.errors){for(var n in t.errors)u[n]&&e.trigger(u[n],t.errors[n],e,n),e.trigger(n,t.errors[n],e,n);e.trigger("error",t.errors,e)}e.trigger("complete",t,e)},n.textResponse=function(e,t,n){var r={};if(e.success||e.errors||e.meta||e.result){e.count!=null&&(n.count=e.count),F(e.success)||(r.success=e.success),F(e.meta)||(r.meta=e.meta),F(e.result)||(r.result=e.result);if(!F(e.errors)){r.errors={};for(var i in e.errors){var s=e.errors[i],o=400;s.code?(o=s.code,s=s.message||s):A(s)&&(o=a[s.toLowerCase()]||400),r.errors[o]||(r.errors[o]={}),r.errors[o][i]={errors:[s]}}}F(r)&&(this.config.options&&this.config.options.snippet?r.result={}:r.success={})}else r={success:e};return r},n.basicResponse=function(e,t,n){var r={success:{}};return r.success=e,r},n.binaryUpload=function(e,t,n,r){var i=w();return v&&t instanceof v?(t=t.toString("base64"),r||(r=l)):(t.toDataURL&&(t=t.toDataURL(r)),t=t.replace(/^data:(.*?);?base64,/,""),r||(r=RegExp.$1||l)),e.setContentType("multipart/form-data; boundary="+i),e.setData(["--"+i,'Content-Disposition: form-data; name="file"; filename="'+n+'"',"Content-Type: "+r,"Content-Transfer-Encoding: base64","",t,"--"+i+"--"].join("\r\n"))};var r={};i.prototype={getResponseHeader:function(e){return this._headers[e]},getAllResponseHeaders:function(){return this._headers},abort:function(){this._request&&(this._textStatus="abort",this._request.abort(),this._request=undefined,delete this._request)}};var s={limit:"limit",sort:"sort",skip:"skip",snippet:"f",params:"params",dontwait:"async",resultsonly:"result_only",count:"count",distance:"distance",units:"units"},o={async:!0,later:!1,processData:!1,dataType:"text",processResponse:n.textResponse,crossDomain:!0,cache:!1},u={200:"ok",201:"created",400:"badrequest",401:"unauthorized",404:"notfound",409:"conflict",500:"servererror"},a={"bad request":400,"permission denied":401,unauthorized:401,"key does not exist":404,"not found":404,conflict:409},f=this.window?window:root,l="application/octet-stream",c=f.File,h=f.FileReader,p=f.BlobBuilder||f.WebKitBlobBuilder||f.MozBlobBuilder||f.MSBlobBuilder,d=f.ArrayBuffer,v=f.Buffer,m=f.CanvasRenderingContext2D,g=[c,v,m,d,f.Uint8Array,f.Uint8ClampedArray,f.Uint16Array,f.Uint32Array,f.Int8Array,f.Int16Array,f.Int32Array,f.Float32Array,f.Float64Array],y=/[^a-zA-Z0-9._-]/g,J,K,Q,G,Y,Z,et="https://api.cloudmine.me";if(!this.window)Y=!0,Z=require("url"),J=require("http"),Q=require("https"),module.exports={WebService:e},G=function(e,t){return new i(e,t)},K=function(e,t){return(new v(e,t||"utf8")).toString("base64")};else{Y=!1,window.cloudmine=window.cloudmine||{},window.cloudmine.WebService=e,K=window.btoa,window.cloudmine.API&&(et=window.cloudmine.API);if(($=this.jQuery||this.Zepto)==null)throw new Error("Missing jQuery-compatible ajax implementation");G=$.ajax,$.support&&($.support.cors=!0)}})()